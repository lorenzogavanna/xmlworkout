<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>QDomyos xml workout creator</title>
        <style>
            @keyframes blink {
                0% {
                    opacity: 1;
                }
                50% {
                    opacity: 0;
                }
                100% {
                    opacity: 1;
                }
            }
            body {
                font-family: Arial, sans-serif;
                background-color: #f7f9fc;
                font-size: 14px;
                color: #333;
                margin: 0;
                padding: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
            }
			.selectors{
				width: 8ch;
				
			}
            .hidden {
                visibility: hidden;
            }
            .showed {
                visibility: visible;
            }
            form {
                background: #fff;
                border: 1px solid#dcdfe6;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 20px 30px;
                width: 100%;
                max-width: 500px;
            }
            .typesDiv {
                display: flex;
            }
            .typeDiv {
                margin: 1px;
                width: 50%;
                border: solid 1px#000;
            }
            .titleDiv {
                font-weight: 700;
                margin-right: 10px;
            }
            label {
                font-weight: 700;
                margin-right: 10px;
            }
            ,
            input[type="number"],
            input[type="text"], select {
                padding: 5px;
                margin: 5px;
                border: 1px solid#dcdfe6;
                border-radius: 4px;
                width: 100%;
                max-width: 110px;
            }
            input[type="checkbox"] {
                margin-right: 5px;
            }
            div.type-selector {
                margin-top: 10px;
                margin-bottom: 20px;
            }
			.inputsDiv{
				height: 50px;
			}

            button {
                background-color: #007bff;
                color: #fff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px 2px;
                transition: background-color 0.3s ease;
            }
            button:hover {
                background-color: #0056b3;
            }
            button:disabled {
                background-color: #cbd3da;
                cursor: not-allowed;
            }
            p#result {
                margin-top: 20px;
                font-size: 13px;
                color: #333;
                text-align: center;
                background-color: silver;
            }
            @media (max-width: 600px) {
                form {
                    padding: 15px;
                }
                label {
                    display: block;
                    margin-bottom: 5px;
                }
                input[type="number"],
                input[type="text"],
                select {               
                padding: 5px 5px 5px 5px;
                margin: 5px;
                border: 1px solid#dcdfe6;
                border-radius: 4px;
                width: 93%;			
                }
                button {
                    width: 100%;
                    margin: 5px 0;
                }
            }
        </style>
    </head>
    <body>
        <form id="workout-form">
            <div><label>QDomyos xml Workout creator</label></div>
            <label>Workout Title:</label><input id="title" /><br>
            <span>Row Type:</span><br>
			<div id="slectorsDiv" style="display: flex; align-items: center;">
				<input type="radio" id="durationType" name="rowType" value="duration" onchange='changeType("durationDiv","distanceDiv")' checked="checked" /><label for="durationType">Duration</label>
				<input type="radio" id="distanceType" name="rowType" value="distance" onchange='changeType("distanceDiv","durationDiv")' /><label for="distanceType">Distance(km)</label>
            </div>
			<div class="inputsDiv" >
				<div class="type-selector" id="distanceDiv" style="display: none;">
					<input type="number" id="distance" name="distance" inputmode="numeric" oninput='ckMax("distance",100)' style="width: 8ch;" value="1" />
				</div>
				<div class="type-selector" id="durationDiv">                
					<select class="selectors" id="hours" name="hours">
						<option disabled="disabled" selected="selected">00</option>
					</select>
					<span>:</span>
					<select class="selectors" id="minutes" name="minutes">
						<option disabled="disabled" selected="selected">00</option>
					</select>
					<span>:</span>
					<select class="selectors" id="seconds" name="seconds">
						<option disabled="disabled" selected="selected">01</option>
					</select>
				</div>
			</div>
            <input type="checkbox" id="ckPid" name="ckPid" onchange='tgHide("pid")' /><label for="ckPid">Pid(zone hr 1-5)</label>           
			<select id="pid" name="pid" class="hidden" onchange='colorOptionBox("pid")'>
                <option id="pid_0" value="0" style="background-color: #fff;">0</option>
                <option id="pid_1" value="1" style="background-color: #9bc2e6;">1</option>
                <option id="pid_2" selected="selected" value="2" style="background-color: #a9d08e;">2</option>
                <option id="pid_3" value="3" style="background-color: #ffff8b;">3</option>
                <option id="pid_4" value="4" style="background-color: #ff8a33;">4</option>
                <option id="pid_5" value="5" style="background-color: #ff4f4f;">5</option>
            </select>
			<input type="checkbox" id="ckHr" name="ckHr" onchange='tgHide("hrmin","hrmax")' /><label for="ckHr">Hr min/max</label>   
				<input type="number" id="hrmin" name="hrmin" class="hidden" min="0" inputmode="numeric" oninput='ckMax("hrmin",300)' style="width: 7ch;" value="0" />
				<input type="number" id="hrmax" name="hrmax" class="hidden" min="0" inputmode="numeric" oninput='ckMax("hrmax",300)' style="width: 7ch;" value="0" /><br>
					<div id="loopDiv" class="hidden">
						<label for="looptimehr">Looptime HR</label>  
						<input type="number" id="looptimehr" name="looptimehr" min="0" inputmode="numeric" oninput='ckMax("looptimehr",300)' style="width: 7ch;" value="0" /><br>
					</div>
            <div class="typesDiv">
                <div id="runDiv" class="typeDiv">
                    <div class="titleDiv">Run</div>
                    <input type="checkbox" id="ckPowerzone" name="powerspeed" onchange='tgHide("powerzone")' /><label for="ckPowerzone">Powerzone</label>
                    <select id="powerzone" name="powerzone" class="hidden" onchange='colorOptionBox("powerzone")'>
                        <option id="powerzone_1" value="1" style="background-color: #d0cece;">Z1&lt;60%</option>
                        <option id="powerzone_2" value="2" style="background-color: #9bc2e6;" selected="selected">Z2 60-75%</option>
                        <option id="powerzone_3" value="3" style="background-color: #a9d08e;">Z3 76-89%</option>
                        <option id="powerzone_4" value="4" style="background-color: #ffff8b;">Z4 90-104%</option>
                        <option id="powerzone_5" value="5" style="background-color: #ff8a33;">Z5 105-118%</option>
                        <option id="powerzone_6" value="6" style="background-color: #ff4f4f;">Z6&gt;118%</option>
                    </select>
                    <br>
                    <input type="checkbox" id="ckSpeed" name="powerspeed" onchange='tgHide("speed")' /><label for="ckSpeed">Speed(km/h)</label>
                    <input type="number" id="speed" name="speed" min="0.1" inputmode="numeric" oninput='ckMax("speed",100)' class="hidden" style="width: 7ch;" value="7" /><br>
                    <input type="checkbox" id="ckMaxSpeed" name="ckMaxSpeed" onchange='tgHide("maxspeed")' /><label for="ckMaxSpeed">Max Speed(km/h)</label>
                    <input type="number" id="maxspeed" name="maxspeed" min="0.2" inputmode="numeric" oninput='ckMax("maxspeed",100)' class="hidden" style="width: 7ch;" value="12" /><br>
                    <input type="checkbox" id="ckInclination" name="ckInclination" onchange='tgHide("inclination")' /><label for="ckInclination">Incline</label>
                    <input type="number" id="inclination" name="inclination" inputmode="numeric" oninput='ckMax("inclination",100)' class="hidden" style="width: 7ch;" value="0" /><br>
                    <input type="checkbox" id="ckFanspeed" name="ckFanspeed" onchange='tgHide("fanspeed")' /><label for="ckFanspeed">Fanspeed</label>
                    <input type="number" id="fanspeed" name="fanspeed" min="0.1" inputmode="numeric" oninput='ckMax("fanspeed",100)' class="hidden" style="width: 7ch;" value="0" /><br>
                    <input type="checkbox" id="ckRamp" name="powerspeed" onchange='tgHide("rampsDiv")' /><label for="ckRamp">Ramp</label>
                    <div id="rampsDiv" class="hidden">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;"><input type="radio" id="powerzoneramp" name="ramps" value="powerzoneramp" checked="checked" /><label for="powerzoneramp">Powerzone%</label></div>
                        <div style="display: flex; align-items: center; margin-bottom: 5px;"><input type="radio" id="speedramp" name="ramps" value="speedramp" /><label for="speedramp">Speed</label></div>
                        <input type="number" id="rampfrom" name="rampfrom" min="0" inputmode="numeric" oninput='ckMax("rampfrom",100)' style="width: 7ch;" value="0" />
                        <input type="number" id="rampto" name="rampto" min="0" inputmode="numeric" oninput='ckMax("rampto",100)' style="width: 7ch;" value="0" /><br>
                    </div>
                </div>
                <div id="bikeDiv" class="typeDiv">
                    <div class="titleDiv">Bike</div>
                    <input type="checkbox" id="ckCadence" name="ckCadence" onchange='tgHide("cadence")' /><label for="ckCadence">Cadence(rpm)</label>
                    <input type="number" id="cadence" name="cadence" min="0.1" inputmode="numeric" oninput='ckMax("cadence",300)' class="hidden" style="width: 7ch;" value="0" /><br>
                    <input type="checkbox" id="ckResistance" name="ckResistance" onchange='tgHide("resistance")' /><label for="ckResistance">Resistance</label>
                    <input type="number" id="resistance" name="resistance" min="0.1" inputmode="numeric" oninput='ckMax("resistance",300)' class="hidden" style="width: 7ch;" value="0" /><br>
                    <input type="checkbox" id="ckPelotonResistance" name="ckPelotonResistance" onchange='tgHide("requested_peloton_resistance")' /><label for="ckPelotonResistance">Peloton Resistance</label>
                    <input type="number" id="requested_peloton_resistance" name="requested_peloton_resistance" min="0.1" inputmode="numeric" oninput='ckMax("requested_peloton_resistance",300)' class="hidden" style="width: 7ch;" value="0" />
                </div>
            </div>
            <label for="repeats">Repeats</label><input type="number" id="repeats" name="repeats" min="1" inputmode="numeric" style="width: 7ch;" value="3" />
            <button type="button" id="startInterval" onclick="startIntervals()">Start Interval</button><br>
            <br>
            <button type="button" onclick="addRow()">Add row</button><button type="button" onclick="resetRow()">Reset</button><button type="button" id="undo" onclick="undoLastRow()">Remove last row</button>
            <button type="button" id="download" onclick="downloadXML()">Download XML</button>
            <p class="resultbox" id="result"></p>
        </form>
        <script>
            colorOptionBox("power");
            colorOptionBox("pid");
            let str;
            let str1 = `\n` + "<row ";
            function colorOptionBox(kind) {
                if ((kind = "pid")) {
                    const select = document.getElementById("pid");
                    const selectedValue = select.value;
                    const colorMap = { "0": "#ffffff", "1": "#9bc2e6", "2": "#a9d08e", "3": "#ffff8b", "4": "#ff8a33", "5": "#ff8a33" };
                    select.style.backgroundColor = colorMap[selectedValue];
                }
                if ((kind = "power")) {
                    const select = document.getElementById("powerzone");
                    const selectedValue = select.value;
                    const colorMap = { "1": "#d0cece", "2": "#9bc2e6", "3": "#a9d08e", "4": "#ffff8b", "5": "#ff8a33", "6": "#ff4f4f" };
                    select.style.backgroundColor = colorMap[selectedValue];
                }
                kind = "";
            }
            function startIntervals() {
                if (document.getElementById("startInterval").textContent == "Start Interval") {
                    document.getElementById("startInterval").style.animation = "blink 2s infinite";
                    document.getElementById("startInterval").style.backgroundColor = "#F67280";
                    document.getElementById("startInterval").textContent = "Close Interval";
                    document.getElementById("result").innerText += `\n` + '<repeat times="' + document.getElementById("repeats").value + '">';
                } else {
                    document.getElementById("startInterval").style.animation = "none";
                    document.getElementById("startInterval").textContent = "Start Interval";
                    document.getElementById("startInterval").style.backgroundColor = "";
                    document.getElementById("result").innerText += `\n` + "</repeat>";
                }
            }
            function downloadXML() {
                if (document.getElementById("startInterval").textContent != "Start Interval") {
                    alert("Close the repeat before the download!");
                } else {
                    const str0 = '<?xml version="1.0" encoding="UTF-8"?>' + `\n` + "<rows>" + `\n`;
                    const xmlContent = str0 + document.getElementById("result").innerText + `\n` + `\n` + "</rows>";
                    const blob = new Blob([xmlContent], { type: "application/xml" });
                    const a = document.createElement("a");
                    a.href = URL.createObjectURL(blob);
                    if (document.getElementById("title").value) {
                        a.download = document.getElementById("title").value + ".xml";
                    } else {
                        a.download = "workout.xml";
                    }
                    a.click();
                    URL.revokeObjectURL(a.href);
                }
            }
            function resetRow() {
                if (document.getElementById("startInterval").textContent != "Start Interval") {
                    document.getElementById("startInterval").style.animation = "none";
                    document.getElementById("startInterval").textContent = "Start Interval";
                    document.getElementById("startInterval").style.backgroundColor = "";
                }
                str = "";
                document.getElementById("result").innerText = "";
            }
            function tgHide(idTg1, idTg2, idTg3) {
                let myEl1 = document.getElementById(idTg1);
                let myEl2 = document.getElementById(idTg2);
                let myEl3 = document.getElementById(idTg3);
                if (myEl1) {
                    myEl1.classList.toggle("hidden");
                }
                if (myEl2) {
                    myEl2.classList.toggle("hidden");
                }
                if (myEl3) {
                    myEl3.classList.toggle("hidden");
                }
                if (idTg1 === "powerzone" || idTg2 === "powerzone" || idTg3 === "powerzone") {
                    document.getElementById("speed").classList.value = "hidden";
                    document.getElementById("ckSpeed").checked = !1;
                    document.getElementById("rampsDiv").classList.value = "hidden";
                    document.getElementById("ckRamp").checked = !1;
                } else if (idTg1 === "speed" || idTg2 === "speed" || idTg3 === "speed") {
                    document.getElementById("powerzone").classList.value = "hidden";
                    document.getElementById("ckPowerzone").checked = !1;
                    document.getElementById("rampsDiv").classList.value = "hidden";
                    document.getElementById("ckRamp").checked = !1;
                } else if (idTg1 === "rampsDiv" || idTg2 === "rampsDiv" || idTg3 === "rampsDiv") {
                    document.getElementById("powerzone").classList.value = "hidden";
                    document.getElementById("ckPowerzone").checked = !1;
                    document.getElementById("speed").classList.value = "hidden";
                    document.getElementById("ckSpeed").checked = !1;
                }
                if (idTg1 === "hrmin" || idTg2 === "hrmin" || idTg3 === "hrmin") {
                    document.getElementById("pid").classList.value = "hidden";
                    document.getElementById("ckPid").checked = !1;
					
                } else if (idTg1 === "hrmax" || idTg2 === "hrmax" || idTg3 === "hrmax") {
                    document.getElementById("pid").classList.value = "hidden";
                    document.getElementById("ckPid").checked = !1;
                } else if (idTg1 === "pid" || idTg2 === "pid" || idTg3 === "pid") {
                    document.getElementById("hrmin").classList.value = "hidden";
                    document.getElementById("hrmax").classList.value = "hidden";
                    document.getElementById("ckHr").checked = !1;
                }			

            }
			document.getElementById("ckPid").addEventListener("change", function () {
				const looptimehrDiv = document.getElementById("loopDiv");
				if (document.getElementById("ckPid").checked || document.getElementById("ckHr").checked) {
					looptimehrDiv.classList.remove("hidden");
				} else {
					looptimehrDiv.classList.add("hidden");
				}
			});

			document.getElementById("ckHr").addEventListener("change", function () {
				const looptimehrDiv = document.getElementById("loopDiv");

				if (document.getElementById("ckPid").checked || document.getElementById("ckHr").checked) {
					looptimehrDiv.classList.remove("hidden");
				} else {
					looptimehrDiv.classList.add("hidden");
				}
			});

		function changeType(idShow, idHide) {
                let myElShow = document.getElementById(idShow);
                let myElHide = document.getElementById(idHide);
                if (myElShow.style.display == "none") {
                    myElShow.style.display = "";
                    myElHide.style.display = "none";
                }
            }
            function populateSelect(id, max) {
                const select = document.getElementById(id);
                for (let i = 0; i <= max; i++) {
                    const option = document.createElement("option");
                    option.value = i;
                    option.textContent = i.toString().padStart(2, "0");
                    select.appendChild(option);
                }
            }
            populateSelect("hours", 8);
            populateSelect("minutes", 59);
            populateSelect("seconds", 59);
            populateSelect("distance", 100);
            function addRow() {
                if (document.getElementById("durationType").checked) {
                    const hours = document.getElementById("hours").value;
                    const minutes = document.getElementById("minutes").value;
                    const seconds = document.getElementById("seconds").value;
                    if (hours && minutes && seconds) {
                        str = str1 + 'duration="' + `${hours.padStart(2, "0")}:${minutes.padStart(2, "0")}:${seconds.padStart(2, "0")}` + '"';
                    } else {
                        alert("Please set a duration.");
                    }
                } else {
                    const distance = document.getElementById("distance").value;
                    str = "";
                    str = str1 + 'distance="' + distance + '"';
                }
                if (document.getElementById("ckHr").checked) {
                    if (document.getElementById("hrmin").value>0){
						str += ' hrmin="' + document.getElementById("hrmin").value + '"';
					}
					if (document.getElementById("hrmax").value>0){
						str += ' hrmax="' + document.getElementById("hrmax").value + '"';
					}
                }
                if (document.getElementById("ckPid").checked) {
                    str += ' zonehr="' + document.getElementById("pid").value + '"';
                }
                if ((document.getElementById("ckPid").checked || document.getElementById("ckHr").checked) && document.getElementById("looptimehr").value>0) {
					str += ' looptimehr="' + document.getElementById("looptimehr").value + '"';
                }
                if (document.getElementById("ckSpeed").checked) {
                    str += ' speed="' + document.getElementById("speed").value + '"';
                }
                if (document.getElementById("ckMaxSpeed").checked) {
                    str += ' maxspeed="' + document.getElementById("maxspeed").value + '"';
                }
                if (document.getElementById("ckInclination").checked) {
                    str += ' inclination="' + document.getElementById("inclination").value + '"';
                }
                if (document.getElementById("ckFanspeed").checked) {
                    str += ' fanspeed="' + document.getElementById("fanspeed").value + '"';
                }
                if (document.getElementById("ckCadence").checked) {
                    str += ' cadence="' + document.getElementById("cadence").value + '"';
                }
                if (document.getElementById("ckResistance").checked) {
                    str += ' resistance="' + document.getElementById("resistance").value + '"';
                }
                if (document.getElementById("ckPelotonResistance").checked) {
                    str += ' requested_peloton_resistance="' + document.getElementById("requested_peloton_resistance").value + '"';
                }
                if (document.getElementById("ckRamp").checked) {
                    if (document.getElementById("powerzoneramp").checked) {
                        str += ' powerzonefrom="' + document.getElementById("rampfrom").value + '"' + ' powerzoneto="' + document.getElementById("rampto").value + '"';
                    } else if (document.getElementById("speedramp").checked) {
                        str += ' speedfrom="' + document.getElementById("rampfrom").value + '"' + ' speedto="' + document.getElementById("rampto").value + '"';
                    }
                }
                if (document.getElementById("ckPowerzone").checked) {
                    document.getElementById("powerzone").value;
                    const powerZones = { 1: [0.4, 0.59], 2: [0.6, 0.75], 3: [0.76, 0.89], 4: [0.9, 1.04], 5: [1.05, 1.18], 6: [1.19, 1.3] };
                    const lastZone = document.getElementById("powerzone").value;
                    const pzone = randomInRange(powerZones[lastZone]);
                    str += ' powerzone="' + pzone + '"';
                }
                str += ' forcespeed="1"/>';
                document.getElementById("result").innerText += str;
            }
            function randomInRange([min, max]) {
                return (Math.random() * (max - min) + min).toFixed(2);
            }
            function ckMax(id, max) {
                if (document.getElementById(id).value > max) {
                    document.getElementById(id).value = max;
                }
            }
            function undoLastRow() {
                let currentText = document.getElementById("result").innerText;
                let lines = currentText.split("\n");
                let lastLine = lines[lines.length - 1];
                lines.pop();
                let updatedText = lines.join("\n");
                document.getElementById("result").innerText = updatedText;
                if (lastLine == "</repeat>") {
                    document.getElementById("startInterval").style.animation = "blink 2s infinite";
                    document.getElementById("startInterval").style.backgroundColor = "#F67280";
                    document.getElementById("startInterval").textContent = "Close Interval";
                } else {
                    document.getElementById("startInterval").style.animation = "none";
                    document.getElementById("startInterval").style.backgroundColor = "";
                    document.getElementById("startInterval").textContent = "Start Interval";
                }
            }
            function validateNumberInput(input) {
                let value = input.value;
                const cursorPosition = input.selectionStart;
                value = value.replace(/,/g, ".");
                value = value.replace(/[^0-9.]/g, "");
                value = value.replace(/(\..*?)\./g, "$1");
                const match = value.match(/^(\d+(\.\d{0,2})?)?/);
                value = match ? match[0] : "";
                const minValue = input.getAttribute("min") ? parseFloat(input.getAttribute("min")) : -Infinity;
                const maxValue = input.getAttribute("max") ? parseFloat(input.getAttribute("max")) : Infinity;
                const numericValue = parseFloat(value);
                if (!isNaN(numericValue)) {
                    value = Math.max(minValue, Math.min(numericValue, maxValue)).toString();
                }
                input.value = value;
                input.setSelectionRange(cursorPosition, cursorPosition);
            }
            function initializeNumberInputs() {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                numberInputs.forEach((input) => {
                    if (input.value === "") {
                        const minValue = input.getAttribute("min");
                        if (minValue) {
                            input.value = parseFloat(minValue).toFixed(2);
                        }
                    }
                    input.addEventListener("input", () => validateNumberInput(input));
                    if (input.value.endsWith(".")) {
                        input.value = input.value.slice(0, -1);
                    }
                    validateNumberInput(input);
                });
            }
            function validateNumberInput(input) {
                let value = input.value;
                value = value.replace(/[^\d.,]/g, "");
                if (value.includes(",")) {
                    value = value.replace(",", ".");
                }
                if ((value.match(/\./g) || []).length > 1) {
                    value = value.replace(/\.(?=.*\.)/, "");
                }
                const parts = value.split(".");
                if (parts.length > 1) {
                    parts[1] = parts[1].substring(0, 2);
                    value = parts.join(".");
                }
                const minValue = input.getAttribute("min") ? parseFloat(input.getAttribute("min")) : -Infinity;
                const maxValue = input.getAttribute("data-max") ? parseFloat(input.getAttribute("data-max")) : Infinity;
                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    value = Math.max(minValue, Math.min(numValue, maxValue)).toString();
                } else {
                    value = "";
                }
                input.value = value;
            }
            function initializeNumberInputs() {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                numberInputs.forEach((input) => {
                    input.addEventListener("blur", (e) => validateNumberInput(input));
                });
            }
            document.addEventListener("DOMContentLoaded", initializeNumberInputs);
            function log(a, b, c, d, e, f, g, h, i) {
                console.log(...[a, b, c, d, e, f, g, h, i].filter((value) => value !== undefined));
            }
        </script>
    </body>
</html>
